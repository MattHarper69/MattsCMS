<?php//--------Set key to start include files	define( 'SITE_KEY', 1 );	$file_path_offset = '../../';//----Get Common code to all pages	require_once ($file_path_offset.'includes/common.php');	require_once ($file_path_offset.'includes/access.php');	require_once ('cms_update_common.php');	//require_once ('cms_update_sweeps_functions.php');			//	set local vars - avoid errors	if (!isset($_SESSION['update_success_msg']))	{		$_SESSION['update_success_msg'] = '';	}		if(!isset($_SESSION['update_error_msg']))	{		$_SESSION['update_error_msg'] = '';	}			if (!isset($error))	{		$error = '';	}			if (isset($_SESSION['access']) AND $_SESSION['access'] < 6 )	{					//	remove quotes		foreach($_POST as $key => $value)		{				$_POST[$key] = str_replace('"', '&quot;', $_POST[$key]);			$_POST[$key] = str_replace("'", '&#39;' , $_POST[$key]);		}				//	Update "All Events" - general settings		if ( isset($_POST['update_events']))		{				$mysql_err_msg = 'Up-dating Event Listings';						if (isset($_POST['display_heads']) AND $_POST['display_heads'] == 'on')			{$display_heads = 'on';}			else	{$display_heads = '';}						if (isset($_POST['display_date']) AND $_POST['display_date'] == 'on')			{$display_date = 'on';}			else	{$display_date = '';}				if (isset($_POST['display_time']) AND $_POST['display_time'] == 'on')			{$display_time = 'on';}			else	{$display_time = '';}									if (isset($_POST['display_image']) AND $_POST['display_image'] == 'on')			{$display_image = 'on';}			else	{$display_image = '';}						$sql_str = '';			for ($i = 1; $i < 6; $i++)			{				if (isset($_POST['field_active_'.$i]))				{					$sql_str .= ', field_active_'.$i.' = "on"';					$sql_str .= ', field_head_'.$i.' = "'.$_POST['field_head_'.$i].'"';								}				else				{					$sql_str .= ', field_active_'.$i.' = ""';				}							}						$sql_statement = 'UPDATE mod_event_list_config SET'												.'  name = "'.$_POST['name'].'"'																	.', event_alias = "'.$_POST['event_alias'].'"'									.', display_heads = "'.$display_heads.'"'									.', display_by = "'.$_POST['display_by'].'"'									.', display_date = "'.$display_date.'"'									.', display_time = "'.$display_time.'"'									.', display_image = "'.$display_image.'"'																		.   $sql_str																		.' WHERE mod_id = "'.$_POST['mod_id'].'"'																		;							if(!UpdateDB ($sql_statement, $mysql_err_msg))			{				$_SESSION['update_error_msg'] = ' - Database Error: Could not Update Event Information \n';			}					}		if (isset($_POST['num_records']))			{				// Now cycle thru all events and update or delete			for ($count = 1; $count <= $_POST['num_records']; $count++)			{				//	Delete individual Item				if (isset($_POST['submit_delete_event_'.$count]))				{										$mysql_err_msg = 'deleting Event';					$sql_statement = 'DELETE FROM mod_event_list WHERE event_id = "'.$_POST['event_id_'.$count].'"';										if(!UpdateDB ($sql_statement, $mysql_err_msg)) { $error = TRUE;}												}								//	Update ALL				elseif ( isset($_POST['update_events']))				{					//	Delete					if (!empty($_POST['delete']) AND in_array( $_POST['event_id_'.$count], $_POST['delete']))					{						$mysql_err_msg = 'deleting Event';						$sql_statement = 'DELETE FROM mod_event_list WHERE event_id = "'.$_POST['event_id_'.$count].'"';												if(!UpdateDB ($sql_statement, $mysql_err_msg)) { $error = TRUE;}							}										//	OR Update					else					{						$mysql_err_msg = 'Up-dating Event info';												// -----	check the status of 'ACTIVE' check boxes (they are not sent if not ticked)												//	TICKED and sent in active array -- avoid errors by checking that array is not empty first						if ( !empty ($_POST['active']) )						{ 							if (in_array( $_POST['event_id_'.$count], $_POST['active']) ) 							{ $active = 'on';} 							else {$active = '';}						}													//	NOT TICKED						else { $active = '';}												$sql_statement = 'UPDATE mod_event_list SET'																	.' active = "'.$active.'"'											.' WHERE event_id = "'.$_POST['event_id_'.$count].'"'												;																				UpdateDB ($sql_statement, $mysql_err_msg);								//	need to strip non-numbers for Seq						$_POST['seq_'.$count] = preg_replace('/\D/', '',$_POST['seq_'.$count]);													//	process dates and times											$event_date = date("Y-m-d",strtotime($_POST['event_date_'.$count]));										$event_time = date("H:i",strtotime($event_date.' '.$_POST['event_time_'.$count]));						$time = $event_date.' '.$event_time . ':00';										//	loop thru all fields						$sql_str = '';						for ($i = 1; $i < 6; $i++)						{							$sql_str .= ', field_'.$i.' = "'.$_POST['field_'.$i.'_'.$count].'"';												}																					$sql_statement = 'UPDATE mod_event_list SET'																			.'  seq = "'.$_POST['seq_'.$count].'"'												.', display_name = "'.$_POST['display_name_'.$count].'"'												.', time = "'.$time.'"'																								.   $sql_str														.' WHERE event_id = "'.$_POST['event_id_'.$count].'"'													;													if(!UpdateDB ($sql_statement, $mysql_err_msg))						{							$_SESSION['update_error_msg'] .= ' - A Database Error occured \n';						}					}							}						}			}				//	Update "More Settings"		if ( isset($_POST['update_settings']))		{				$mysql_err_msg = 'Up-dating Event Listing Settings';											$sql_statement = 'UPDATE mod_event_list_config SET'												.'  heading = "'.$_POST['heading'].'"'									.', text_1 = "'.$_POST['text_1'].'"'									.', text_2 = "'.$_POST['text_2'].'"'									.', more_info_text = "'.$_POST['more_info_text'].'"'									.', no_events_msg = "'.$_POST['no_events_msg'].'"'									.', time_zone = "'.$_POST['time_zone'].'"'																		.', date_format = "'.$_POST['date_format'].'"'									.', time_format = "'.$_POST['time_format'].'"'									.' WHERE mod_id = "'.$_POST['mod_id'].'"'																		;							if(!UpdateDB ($sql_statement, $mysql_err_msg))			{				$_SESSION['update_error_msg'] = ' - Database Error: Could not Update Event Listing Settings \n';			}					}		}		else	{				$_SESSION['update_error_msg'] .= '- Insufficient Privileges to Modify Data \n';			}					//	check for errors and print MSG	if($error == FALSE)	{		$_SESSION['update_success_msg'] .= "( Update Succesfull ) \n";	}	else	{		$_SESSION['update_error_msg'] .= $error;	}								//	Re-Direct BACK	$return_url = $_POST['return_url'];		header('location: '.$return_url); 	exit();			?>